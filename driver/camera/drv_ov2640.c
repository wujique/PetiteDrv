/**
  ******************************************************************************
  * @file    DCMI/DCMI_CameraExample/dcmi_ov2640.c
  * @author  MCD Application Team
  * @version V1.8.0
  * @date    04-November-2016
  * @brief   This file includes the driver for OV2640 Camera module mounted on
  *          STM324xG-EVAL and STM32437I-EVAL evaluation boards.
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; COPYRIGHT 2016 STMicroelectronics</center></h2>
  *
  * Licensed under MCD-ST Liberty SW License Agreement V2, (the "License");
  * You may not use this file except in compliance with the License.
  * You may obtain a copy of the License at:
  *
  *        http://www.st.com/software_license_agreement_liberty_v2
  *
  * Unless required by applicable law or agreed to in writing, software 
  * distributed under the License is distributed on an "AS IS" BASIS, 
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
  ******************************************************************************
  */
#include "mcu.h"

#include "log.h"
#include "petite_config.h"

#if (DRV_CAMERA_OV2640 == 1)

#include "board_sysconf.h"
#include "bus_i2c.h"
#include "mcu_dcmi.h"

#include "drv_ov2640.h"


extern void Delay(__IO uint32_t nTime);

/** @addtogroup STM32F4xx_StdPeriph_Examples
  * @{
  */

extern const DevI2c DevVi2c1;

#define OV2640_DEVICE_ADDR	0X30
#define OV2640_DEVICE_WRITE_ADDRESS    0x60
#define OV2640_DEVICE_READ_ADDRESS     0x61

/**
  * @brief	Writes a byte at a specific Camera register
  * @param	Addr: OV2640 register address.
  * @param	Data: Data to be written to the specific register 
  * @retval 0x00 if write operation is OK.
  * 	  0xFF if timeout condition occurred (device not connected or bus error).
  */
static uint8_t OV2640_WriteReg(uint16_t Addr, uint8_t Data)
{
	DevI2cNode *node;
	uint8_t res;

	uint8_t buf[2];

  	node = bus_i2c_open(DEV_CAMERA_I2CBUS, 0xffffffff, 200);
	#if 1
	buf[0] = Addr;
	buf[1] = Data;
	res  = 	bus_i2c_transfer(node, OV2640_DEVICE_ADDR, MCU_I2C_MODE_W, buf, 2);
	#else
	res = mcu_sccb_writereg(&DevVi2c1, OV2640_DEVICE_WRITE_ADDRESS, Addr, Data);
	#endif
	bus_i2c_close(node);
	
	return res;
	
	//return bus_sccb_writereg(OV2640_DEVICE_WRITE_ADDRESS, Addr, Data);
}

/**
  * @brief	Reads a byte from a specific Camera register
  * @param	Addr: OV2640 register address.
  * @retval data read from the specific register or 0xFF if timeout condition
  * 		occurred. 
  */
static uint8_t OV2640_ReadReg(uint16_t Addr)
{
	DevI2cNode *node;
	uint8_t res;
	
	node = bus_i2c_open(DEV_CAMERA_I2CBUS, 0xffffffff, 200);

	#if 1
	uint8_t buf[2];
	buf[0] = Addr;

	bus_i2c_transfer(node, OV2640_DEVICE_ADDR, MCU_I2C_MODE_W, buf, 1);
	bus_i2c_transfer(node, OV2640_DEVICE_ADDR, MCU_I2C_MODE_R, buf, 1);
	bus_i2c_close(node);

	return buf[0];
	#else
	res = mcu_sccb_readreg(&DevVi2c1, OV2640_DEVICE_READ_ADDRESS, Addr);
	bus_i2c_close(node);
	return res;
	#endif
  	//return bus_sccb_readreg(OV2640_DEVICE_READ_ADDRESS, Addr);
}

/** @addtogroup DCMI_CameraExample
  * @{
  */ 

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define  TIMEOUT  2

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* QQVGA 160x120 */
const char OV2640_QQVGA[][2]=
{
  0xff, 0x00,  0x2c, 0xff,  0x2e, 0xdf,  0xff, 0x01,
  0x3c, 0x32,  0x11, 0x00,  0x09, 0x02,  0x03, 0xcf,
  0x04, 0x08,  0x13, 0xe5,  0x14, 0x48,  0x2c, 0x0c,
  0x33, 0x78,  0x3a, 0x33,  0x3b, 0xfb,  0x3e, 0x00,
  0x43, 0x11,  0x16, 0x10,  0x39, 0x02,  0x35, 0x88,
  0x22, 0x0a,  0x37, 0x40,  0x23, 0x00,  0x34, 0xa0,
  0x36, 0x1a,  0x06, 0x02,  0x07, 0xc0,  0x0d, 0xb7,
  0x0e, 0x01,  0x4c, 0x00,  0x4a, 0x81,  0x21, 0x99,
  0x24, 0x3a,  0x25, 0x32,  0x26, 0x82,  0x5c, 0x00,
  0x63, 0x00,  0x5d, 0x55,  0x5e, 0x7d,  0x5f, 0x7d,
  0x60, 0x55,  0x61, 0x70,  0x62, 0x80,  0x7c, 0x05,
  0x20, 0x80,  0x28, 0x30,  0x6c, 0x00,  0x6d, 0x80,
  0x6e, 0x00,  0x70, 0x02,  0x71, 0x96,  0x73, 0xe1,
  0x3d, 0x34,  0x5a, 0x57,  0x4f, 0xbb,  0x50, 0x9c,
  0x0f, 0x43,  0xff, 0x00,  0xe5, 0x7f,  0xf9, 0xc0,
  0x41, 0x24,  0xe0, 0x14,  0x76, 0xff,  0x33, 0xa0,
  0x42, 0x20,  0x43, 0x18,  0x4c, 0x00,  0x87, 0xd0,
  0x88, 0x3f,  0xd7, 0x03,  0xd9, 0x10,  0xd3, 0x82,
  0xc8, 0x08,  0xc9, 0x80,  0x7c, 0x00,  0x7d, 0x02,
  0x7c, 0x03,  0x7d, 0x48,  0x7d, 0x48,  0x7c, 0x08,
  0x7d, 0x20,  0x7d, 0x10,  0x7d, 0x0e,  0x90, 0x00,
  0x91, 0x0e,  0x91, 0x1a,  0x91, 0x31,  0x91, 0x5a,
  0x91, 0x69,  0x91, 0x75,  0x91, 0x7e,  0x91, 0x88,
  0x91, 0x8f,  0x91, 0x96,  0x91, 0xa3,  0x91, 0xaf,
  0x91, 0xc4,  0x91, 0xd7,  0x91, 0xe8,  0x91, 0x20,
  0x92, 0x00,  0x93, 0x06,  0x93, 0xe3,  0x93, 0x05,
  0x93, 0x05,  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,
  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,
  0x93, 0x00,  0x93, 0x00,  0x96, 0x00,  0x97, 0x08,
  0x97, 0x19,  0x97, 0x02,  0x97, 0x0c,  0x97, 0x24,
  0x97, 0x30,  0x97, 0x28,  0x97, 0x26,  0x97, 0x02,
  0x97, 0x98,  0x97, 0x80,  0x97, 0x00,  0x97, 0x00,
  0xc3, 0xed,  0xa4, 0x00,  0xa8, 0x00,  0xbf, 0x00,
  0xba, 0xf0,  0xbc, 0x64,  0xbb, 0x02,  0xb6, 0x3d,
  0xb8, 0x57,  0xb7, 0x38,  0xb9, 0x4e,  0xb3, 0xe8,
  0xb4, 0xe1,  0xb5, 0x66,  0xb0, 0x67,  0xb1, 0x5e,
  0xb2, 0x04,  0xc7, 0x00,  0xc6, 0x51,  0xc5, 0x11,
  0xc4, 0x9c,  0xcf, 0x02,  0xa6, 0x00,  0xa7, 0xe0,
  0xa7, 0x10,  0xa7, 0x1e,  0xa7, 0x21,  0xa7, 0x00,
  0xa7, 0x28,  0xa7, 0xd0,  0xa7, 0x10,  0xa7, 0x16,
  0xa7, 0x21,  0xa7, 0x00,  0xa7, 0x28,  0xa7, 0xd0,
  0xa7, 0x10,  0xa7, 0x17,  0xa7, 0x21,  0xa7, 0x00,
  0xa7, 0x28,  0xc0, 0xc8,  0xc1, 0x96,  0x86, 0x1d,
  0x50, 0x00,  0x51, 0x90,  0x52, 0x18,  0x53, 0x00,
  0x54, 0x00,  0x55, 0x88,  0x57, 0x00,  0x5a, 0x90,
  0x5b, 0x18,  0x5c, 0x05,  0xc3, 0xef,  0x7f, 0x00,
  0xda, 0x00,  0xe5, 0x1f,  0xe1, 0x67,  0xe0, 0x00,
  0xdd, 0xff,  0x05, 0x00,  0xff, 0x01,  0xff, 0x01,
  0x12, 0x00,  0x17, 0x11,  0x18, 0x75,  0x19, 0x01,
  0x1a, 0x97,  0x32, 0x36,  0x4f, 0xbb,  0x6d, 0x80,
  0x3d, 0x34,  0x39, 0x02,  0x35, 0x88,  0x22, 0x0a,
  0x37, 0x40,  0x23, 0x00,  0x34, 0xa0,  0x36, 0x1a,
  0x06, 0x02,  0x07, 0xc0,  0x0d, 0xb7,  0x0e, 0x01,
  0x4c, 0x00,  0xff, 0x00,  0xe0, 0x04,  0x8c, 0x00,
  0x87, 0xd0,  0xe0, 0x00,  0xff, 0x00,  0xe0, 0x14,
  0xe1, 0x77,  0xe5, 0x1f,  0xd7, 0x03,  0xda, 0x10,
  0xe0, 0x00,  0xff, 0x00,  0xe0, 0x04,  0xc0, 0xc8,
  0xc1, 0x96,  0x86, 0x1d,  0x50, 0x00,  0x51, 0x90,
  0x52, 0x2c,  0x53, 0x00,  0x54, 0x00,  0x55, 0x88,
  0x57, 0x00,  0x5a, 0x90,  0x5b, 0x2c,  0x5c, 0x05,
  0xe0, 0x00,  0xd3, 0x04,  0xff, 0x00,  0xc3, 0xef,
  0xa6, 0x00,  0xa7, 0xdd,  0xa7, 0x78,  0xa7, 0x7e,
  0xa7, 0x24,  0xa7, 0x00,  0xa7, 0x25,  0xa6, 0x06,
  0xa7, 0x20,  0xa7, 0x58,  0xa7, 0x73,  0xa7, 0x34,
  0xa7, 0x00,  0xa7, 0x25,  0xa6, 0x0c,  0xa7, 0x28,
  0xa7, 0x58,  0xa7, 0x6d,  0xa7, 0x34,  0xa7, 0x00,
  0xa7, 0x25,  0xff, 0x00,  0xe0, 0x04,  0xe1, 0x67,
  0xe5, 0x1f,  0xd7, 0x01,  0xda, 0x08,  0xda, 0x09,
  0xe0, 0x00,  0x98, 0x00,  0x99, 0x00,  0xff, 0x01,
  0x04, 0x28,  0xff, 0x01,  0x12, 0x40,  0x17, 0x11,
  0x18, 0x43,  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,
  0x4f, 0xca,  0x50, 0xa8,  0x5a, 0x23,  0x6d, 0x00,
  0x39, 0x12,  0x35, 0xda,  0x22, 0x1a,  0x37, 0xc3,
  0x23, 0x00,  0x34, 0xc0,  0x36, 0x1a,  0x06, 0x88,
  0x07, 0xc0,  0x0d, 0x87,  0x0e, 0x41,  0x4c, 0x00,
  0xff, 0x00,  0xe0, 0x04,  0xc0, 0x64,  0xc1, 0x4b,
  0x86, 0x35,  0x50, 0x92,  0x51, 0xc8,  0x52, 0x96,
  0x53, 0x00,  0x54, 0x00,  0x55, 0x00,  0x57, 0x00,
  0x5a, 0x28,  0x5b, 0x1e,  0x5c, 0x00,  0xe0, 0x00,
  0xff, 0x01,  0x11, 0x00,  0x3d, 0x38,  0x2d, 0x00,
  0x50, 0x65,  0xff, 0x00,  0xd3, 0x04,  0x7c, 0x00,
  0x7d, 0x04,  0x7c, 0x09,  0x7d, 0x28,  0x7d, 0x00,
};

/* QVGA 320x240 */
const unsigned char OV2640_QVGA[][2]=
{
  0xff, 0x00,  0x2c, 0xff,  0x2e, 0xdf,  0xff, 0x01,
  0x3c, 0x32,  0x11, 0x00,  0x09, 0x02,  0x04, 0x28,
  0x13, 0xe5,  0x14, 0x48,  0x2c, 0x0c,  0x33, 0x78,
  0x3a, 0x33,  0x3b, 0xfB,  0x3e, 0x00,  0x43, 0x11,
  0x16, 0x10,  0x4a, 0x81,  0x21, 0x99,  0x24, 0x40,
  0x25, 0x38,  0x26, 0x82,  0x5c, 0x00,  0x63, 0x00,
  0x46, 0x3f,  0x0c, 0x3c,  0x61, 0x70,  0x62, 0x80,
  0x7c, 0x05,  0x20, 0x80,  0x28, 0x30,  0x6c, 0x00,
  0x6d, 0x80,  0x6e, 0x00,  0x70, 0x02,  0x71, 0x94,
  0x73, 0xc1,  0x3d, 0x34,  0x5a, 0x57,  0x12, 0x00,
  0x11, 0x00,  0x17, 0x11,  0x18, 0x75,  0x19, 0x01,
  0x1a, 0x97,  0x32, 0x36,  0x03, 0x0f,  0x37, 0x40,
  0x4f, 0xbb,  0x50, 0x9c,  0x5a, 0x57,  0x6d, 0x80,
  0x6d, 0x38,  0x39, 0x02,  0x35, 0x88,  0x22, 0x0a,
  0x37, 0x40,  0x23, 0x00,  0x34, 0xa0,  0x36, 0x1a,
  0x06, 0x02,  0x07, 0xc0,  0x0d, 0xb7,  0x0e, 0x01,
  0x4c, 0x00,  0xff, 0x00,  0xe5, 0x7f,  0xf9, 0xc0,
  0x41, 0x24,  0xe0, 0x14,  0x76, 0xff,  0x33, 0xa0,
  0x42, 0x20,  0x43, 0x18,  0x4c, 0x00,  0x87, 0xd0,
  0x88, 0x3f,  0xd7, 0x03,  0xd9, 0x10,  0xd3, 0x82,
  0xc8, 0x08,  0xc9, 0x80,  0x7d, 0x00,  0x7c, 0x03,
  0x7d, 0x48,  0x7c, 0x08,  0x7d, 0x20,  0x7d, 0x10,
  0x7d, 0x0e,  0x90, 0x00,  0x91, 0x0e,  0x91, 0x1a,
  0x91, 0x31,  0x91, 0x5a,  0x91, 0x69,  0x91, 0x75,
  0x91, 0x7e,  0x91, 0x88,  0x91, 0x8f,  0x91, 0x96,
  0x91, 0xa3,  0x91, 0xaf,  0x91, 0xc4,  0x91, 0xd7,
  0x91, 0xe8,  0x91, 0x20,  0x92, 0x00,  0x93, 0x06,
  0x93, 0xe3,  0x93, 0x02,  0x93, 0x02,  0x93, 0x00,
  0x93, 0x04,  0x93, 0x00,  0x93, 0x03,  0x93, 0x00,
  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,
  0x93, 0x00,  0x93, 0x00,  0x96, 0x00,  0x97, 0x08,
  0x97, 0x19,  0x97, 0x02,  0x97, 0x0c,  0x97, 0x24,
  0x97, 0x30,  0x97, 0x28,  0x97, 0x26,  0x97, 0x02,
  0x97, 0x98,  0x97, 0x80,  0x97, 0x00,  0x97, 0x00,
  0xc3, 0xef,  0xff, 0x00,  0xba, 0xdc,  0xbb, 0x08,
  0xb6, 0x24,  0xb8, 0x33,  0xb7, 0x20,  0xb9, 0x30,
  0xb3, 0xb4,  0xb4, 0xca,  0xb5, 0x43,  0xb0, 0x5c,
  0xb1, 0x4f,  0xb2, 0x06,  0xc7, 0x00,  0xc6, 0x51,
  0xc5, 0x11,  0xc4, 0x9c,  0xbf, 0x00,  0xbc, 0x64,
  0xa6, 0x00,  0xa7, 0x1e,  0xa7, 0x6b,  0xa7, 0x47,
  0xa7, 0x33,  0xa7, 0x00,  0xa7, 0x23,  0xa7, 0x2e,
  0xa7, 0x85,  0xa7, 0x42,  0xa7, 0x33,  0xa7, 0x00,
  0xa7, 0x23,  0xa7, 0x1b,  0xa7, 0x74,  0xa7, 0x42,
  0xa7, 0x33,  0xa7, 0x00,  0xa7, 0x23,  0xc0, 0xc8,
  0xc1, 0x96,  0x8c, 0x00,  0x86, 0x3d,  0x50, 0x92,
  0x51, 0x90,  0x52, 0x2c,  0x53, 0x00,  0x54, 0x00,
  0x55, 0x88,  0x5a, 0x50,  0x5b, 0x3c,  0x5c, 0x00,
  0xd3, 0x04,  0x7f, 0x00,  0xda, 0x00,  0xe5, 0x1f,
  0xe1, 0x67,  0xe0, 0x00,  0xdd, 0x7f,  0x05, 0x00,
  0xff, 0x00,  0xe0, 0x04,  0xc0, 0xc8,  0xc1, 0x96,
  0x86, 0x3d,  0x50, 0x92,  0x51, 0x90,  0x52, 0x2c,
  0x53, 0x00,  0x54, 0x00,  0x55, 0x88,  0x57, 0x00,
  0x5a, 0x50,  0x5b, 0x3c,  0x5c, 0x00,  0xd3, 0x04,
  0xe0, 0x00,  0xFF, 0x00,  0x05, 0x00,  0xDA, 0x08,
  0xda, 0x09,  0x98, 0x00,  0x99, 0x00,  0x00, 0x00,
};

const unsigned char OV2640_JPEG_INIT[][2]=
{
  0xff, 0x00,  0x2c, 0xff,  0x2e, 0xdf,  0xff, 0x01,
  0x3c, 0x32,  0x11, 0x30,  0x09, 0x02,  0x04, 0x28,
  0x13, 0xe5,  0x14, 0x48,  0x2c, 0x0c,  0x33, 0x78,
  0x3a, 0x33,  0x3b, 0xfB,  0x3e, 0x00,  0x43, 0x11,
  0x16, 0x10,  0x39, 0x92,  0x35, 0xda,  0x22, 0x1a,
  0x37, 0xc3,  0x23, 0x00,  0x34, 0xc0,  0x36, 0x1a,
  0x06, 0x88,  0x07, 0xc0,  0x0d, 0x87,  0x0e, 0x41,
  0x4c, 0x00,  0x48, 0x00,  0x5B, 0x00,  0x42, 0x03,
  0x4a, 0x81,  0x21, 0x99,  0x24, 0x40,  0x25, 0x38,
  0x26, 0x82,  0x5c, 0x00,  0x63, 0x00,  0x61, 0x70,
  0x62, 0x80,  0x7c, 0x05,  0x20, 0x80,  0x28, 0x30,
  0x6c, 0x00,  0x6d, 0x80,  0x6e, 0x00,  0x70, 0x02,
  0x71, 0x94,  0x73, 0xc1,  0x12, 0x40,  0x17, 0x11,
  0x18, 0x43,  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,
  0x37, 0xc0,  0x4f, 0x60,  0x50, 0xa8,  0x6d, 0x00,
  0x3d, 0x38,  0x46, 0x3f,  0x4f, 0x60,  0x0c, 0x3c,
  0xff, 0x00,  0xe5, 0x7f,  0xf9, 0xc0,  0x41, 0x24,
  0xe0, 0x14,  0x76, 0xff,  0x33, 0xa0,  0x42, 0x20,
  0x43, 0x18,  0x4c, 0x00,  0x87, 0xd5,  0x88, 0x3f,
  0xd7, 0x03,  0xd9, 0x10,  0xd3, 0x82,  0xc8, 0x08,
  0xc9, 0x80,  0x7c, 0x00,  0x7d, 0x00,  0x7c, 0x03,
  0x7d, 0x48,  0x7d, 0x48,  0x7c, 0x08,  0x7d, 0x20,
  0x7d, 0x10,  0x7d, 0x0e,  0x90, 0x00,  0x91, 0x0e,
  0x91, 0x1a,  0x91, 0x31,  0x91, 0x5a,  0x91, 0x69,
  0x91, 0x75,  0x91, 0x7e,  0x91, 0x88,  0x91, 0x8f,
  0x91, 0x96,  0x91, 0xa3,  0x91, 0xaf,  0x91, 0xc4,
  0x91, 0xd7,  0x91, 0xe8,  0x91, 0x20,  0x92, 0x00,
  0x93, 0x06,  0x93, 0xe3,  0x93, 0x05,  0x93, 0x05,
  0x93, 0x00,  0x93, 0x04,  0x93, 0x00,  0x93, 0x00,
  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,  0x93, 0x00,
  0x93, 0x00,  0x96, 0x00,  0x97, 0x08,  0x97, 0x19,
  0x97, 0x02,  0x97, 0x0c,  0x97, 0x24,  0x97, 0x30,
  0x97, 0x28,  0x97, 0x26,  0x97, 0x02,  0x97, 0x98,
  0x97, 0x80,  0x97, 0x00,  0x97, 0x00,  0xc3, 0xed,
  0xa4, 0x00,  0xa8, 0x00,  0xc5, 0x11,  0xc6, 0x51,
  0xbf, 0x80,  0xc7, 0x10,  0xb6, 0x66,  0xb8, 0xA5,
  0xb7, 0x64,  0xb9, 0x7C,  0xb3, 0xaf,  0xb4, 0x97,
  0xb5, 0xFF,  0xb0, 0xC5,  0xb1, 0x94,  0xb2, 0x0f,
  0xc4, 0x5c,  0xc0, 0x64,  0xc1, 0x4B,  0x8c, 0x00,
  0x86, 0x3D,  0x50, 0x00,  0x51, 0xC8,  0x52, 0x96,
  0x53, 0x00,  0x54, 0x00,  0x55, 0x00,  0x5a, 0xC8,
  0x5b, 0x96,  0x5c, 0x00,  0xd3, 0x7f,  0xc3, 0xed,
  0x7f, 0x00,  0xda, 0x00,  0xe5, 0x1f,  0xe1, 0x67,
  0xe0, 0x00,  0xdd, 0x7f,  0x05, 0x00,

  0x12, 0x40,  0xd3, 0x7f,  0xc0, 0x16,  0xC1, 0x12,
  0x8c, 0x00,  0x86, 0x3d,  0x50, 0x00,  0x51, 0x2C,
  0x52, 0x24,  0x53, 0x00,  0x54, 0x00,  0x55, 0x00,
  0x5A, 0x2c,  0x5b, 0x24,  0x5c, 0x00,
};

const unsigned char OV2640_YUV422[][2]= 
{
  0xFF, 0x00,  0x05, 0x00,  0xDA, 0x10,  0xD7, 0x03,
  0xDF, 0x00,  0x33, 0x80,  0x3C, 0x40,  0xe1, 0x77,
  0x00, 0x00,
};

const unsigned char OV2640_JPEG[][2]=
{
  0xe0, 0x14,  0xe1, 0x77,  0xe5, 0x1f,  0xd7, 0x03,
  0xda, 0x10,  0xe0, 0x00,  0xFF, 0x01,  0x04, 0x08,
};

/* JPG 160x120 */
const unsigned char OV2640_160x120_JPEG[][2]=
{
  0xff, 0x01,  0x12, 0x40,  0x17, 0x11,  0x18, 0x43,
  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,  0x4f, 0xca,
  0x50, 0xa8,  0x5a, 0x23,  0x6d, 0x00,  0x39, 0x12,
  0x35, 0xda,  0x22, 0x1a,  0x37, 0xc3,  0x23, 0x00,
  0x34, 0xc0,  0x36, 0x1a,  0x06, 0x88,  0x07, 0xc0,
  0x0d, 0x87,  0x0e, 0x41,  0x4c, 0x00,  0xff, 0x00,
  0xe0, 0x04,  0xc0, 0x64,  0xc1, 0x4b,  0x86, 0x35,
  0x50, 0x92,  0x51, 0xc8,  0x52, 0x96,  0x53, 0x00,
  0x54, 0x00,  0x55, 0x00,  0x57, 0x00,  0x5a, 0x28,
  0x5b, 0x1e,  0x5c, 0x00,  0xe0, 0x00,
};

/* JPG, 0x176x144 */
const unsigned char OV2640_176x144_JPEG[][2]=
{
  0xff, 0x01,  0x12, 0x40,  0x17, 0x11,  0x18, 0x43,
  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,  0x4f, 0xca,
  0x50, 0xa8,  0x5a, 0x23,  0x6d, 0x00,  0x39, 0x12,
  0x35, 0xda,  0x22, 0x1a,  0x37, 0xc3,  0x23, 0x00,
  0x34, 0xc0,  0x36, 0x1a,  0x06, 0x88,  0x07, 0xc0,
  0x0d, 0x87,  0x0e, 0x41,  0x4c, 0x00,  0xff, 0x00,
  0xe0, 0x04,  0xc0, 0x64,  0xc1, 0x4b,  0x86, 0x35,
  0x50, 0x92,  0x51, 0xc8,  0x52, 0x96,  0x53, 0x00,
  0x54, 0x00,  0x55, 0x00,  0x57, 0x00,  0x5a, 0x2c,
  0x5b, 0x24,  0x5c, 0x00,  0xe0, 0x00,
};

/* JPG 320x240 */
const unsigned char OV2640_320x240_JPEG[][2]=
{
  0xff, 0x01,  0x12, 0x40,  0x17, 0x11,  0x18, 0x43,
  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,  0x4f, 0xca,
  0x50, 0xa8,  0x5a, 0x23,  0x6d, 0x00,  0x39, 0x12,
  0x35, 0xda,  0x22, 0x1a,  0x37, 0xc3,  0x23, 0x00,
  0x34, 0xc0,  0x36, 0x1a,  0x06, 0x88,  0x07, 0xc0,
  0x0d, 0x87,  0x0e, 0x41,  0x4c, 0x00,  0xff, 0x00,
  0xe0, 0x04,  0xc0, 0x64,  0xc1, 0x4b,  0x86, 0x35,
  0x50, 0x89,  0x51, 0xc8,  0x52, 0x96,  0x53, 0x00,
  0x54, 0x00,  0x55, 0x00,  0x57, 0x00,  0x5a, 0x50,
  0x5b, 0x3c,  0x5c, 0x00,  0xe0, 0x00,
};

/* JPG 352x288 */
const unsigned char OV2640_352x288_JPEG[][2]=
{
  0xff, 0x01,  0x12, 0x40,  0x17, 0x11,  0x18, 0x43,
  0x19, 0x00,  0x1a, 0x4b,  0x32, 0x09,  0x4f, 0xca,
  0x50, 0xa8,  0x5a, 0x23,  0x6d, 0x00,  0x39, 0x12,
  0x35, 0xda,  0x22, 0x1a,  0x37, 0xc3,  0x23, 0x00,
  0x34, 0xc0,  0x36, 0x1a,  0x06, 0x88,  0x07, 0xc0,
  0x0d, 0x87,  0x0e, 0x41,  0x4c, 0x00,  0xff, 0x00,
  0xe0, 0x04,  0xc0, 0x64,  0xc1, 0x4b,  0x86, 0x35,
  0x50, 0x89,  0x51, 0xc8,  0x52, 0x96,  0x53, 0x00,
  0x54, 0x00,  0x55, 0x00,  0x57, 0x00,  0x5a, 0x58,
  0x5b, 0x48,  0x5c, 0x00,  0xe0, 0x00,
};
/*--------------------------------------------------------*/
/*OV2640 UXGA初始化寄存器序列表
此模式下帧率为15帧
UXGA(1600*1200) */
const u8 OV2640_1600x1200_UXGA[][2]= 
{   
	0xff, 0x00,	
	0x2c, 0xff,	0x2e, 0xdf,	/*规格书根本没有这些寄存器*/
	
	0xff, 0x01,
	0x3c, 0x32,	
	0x11, 0x00,	/*clock rate control: off*/
	0x09, 0x02,	/*common  control 2: 2x capability*/
	/* 设置 vertical flip， 红色会变绿色 */
	0x04, 0x18|0x40, /* register 04: bit7 horizontal mirror;bit6 vertical flip*/
	0x13, 0xe5,	/* common control 8: */
	0x14, 0x48,	/* common control 9: AGC gain ceiling*/
	0x2c, 0x0c,	/* rsvd */
	0x33, 0x78, /* rsvd */
	0x3a, 0x33,	/* rsvd */
	0x3b, 0xfB,	/* rsvd */
	0x3e, 0x00,	/* rsvd */
	0x43, 0x11, /* rsvd */
	0x16, 0x10,	/* rsvd */
	0x39, 0x92,	/* rsvd */
	0x35, 0xda,	/* rsvd */
	0x22, 0x1a, /* rsvd */
	0x37, 0xc3,	/* rsvd */
	0x23, 0x00,	/* rsvd */
	0x34, 0xc0,	/* ARCOM2: */
	0x36, 0x1a, /* rsvd */
	0x06, 0x88,	/* rsvd */
	0x07, 0xc0,	/* rsvd */
	0x0d, 0x87,	/* rsvd */
	0x0e, 0x41, /* rsvd */
	0x4c, 0x00,	/* rsvd */
	0x48, 0x00,	/* COMMON CONTROL 9*/
	0x5B, 0x00,	/* rsvd */
	0x42, 0x03, /* rsvd */
	0x4a, 0x81,	/* rsvd */
	0x21, 0x99,	/* rsvd */
	0x24, 0x40,	/* AEW : */
	0x25, 0x38, /* AEB :*/
	0x26, 0x82,	/* VV :*/
	0x5c, 0x00,	/* rsvd */
	0x63, 0x00,	/* rsvd */
	0x46, 0x00,
	0x0c, 0x3c,	
	0x61, 0x70,	
	0x62, 0x80,	
	0x7c, 0x05,
	0x20, 0x80,
	0x28, 0x30,	
	0x6c, 0x00,	
	0x6d, 0x80,
	0x6e, 0x00,	
	0x70, 0x02,	0x71, 0x94,	0x73, 0xc1, 
	0x3d, 0x34,	0x5a, 0x57,	0x12, 0x00,	0x17, 0x11,
	0x18, 0x75,	0x19, 0x01,	0x1a, 0x97,	0x32, 0x36,
	0x03, 0x0f,	0x37, 0x40,	0x4f, 0xca,	0x50, 0xa8,
	0x5a, 0x23,	0x6d, 0x00,	0x6d, 0x38,	0xff, 0x00,
	0xe5, 0x7f,	0xf9, 0xc0,	0x41, 0x24,	0xe0, 0x14,
	0x76, 0xff,	0x33, 0xa0,	0x42, 0x20,	0x43, 0x18,
	0x4c, 0x00,	0x87, 0xd5,	0x88, 0x3f,	0xd7, 0x03,
	0xd9, 0x10,	0xd3, 0x82,	0xc8, 0x08,	0xc9, 0x80,
	0x7c, 0x00,	0x7d, 0x00,	0x7c, 0x03,	0x7d, 0x48,
	0x7d, 0x48,	0x7c, 0x08,	0x7d, 0x20,	0x7d, 0x10,
	0x7d, 0x0e,	0x90, 0x00,	0x91, 0x0e,	0x91, 0x1a,
	0x91, 0x31,	0x91, 0x5a,	0x91, 0x69,	0x91, 0x75,
	0x91, 0x7e,	0x91, 0x88,	0x91, 0x8f,	0x91, 0x96,
	0x91, 0xa3,	0x91, 0xaf,	0x91, 0xc4,	0x91, 0xd7,
	0x91, 0xe8,	0x91, 0x20,	0x92, 0x00,	0x93, 0x06,
	0x93, 0xe3,	0x93, 0x05,	0x93, 0x05,	0x93, 0x00,
	0x93, 0x04,	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,
	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,
	0x96, 0x00,	0x97, 0x08,	0x97, 0x19,	0x97, 0x02,
	0x97, 0x0c,	0x97, 0x24,	0x97, 0x30,	0x97, 0x28,
	0x97, 0x26,	0x97, 0x02,	0x97, 0x98,	0x97, 0x80,
	0x97, 0x00,	0x97, 0x00,	0xc3, 0xef,	0xa4, 0x00,
	0xa8, 0x00,	0xc5, 0x11,	0xc6, 0x51,	0xbf, 0x80,
	0xc7, 0x10,	0xb6, 0x66,	0xb8, 0xA5,	0xb7, 0x64,
	0xb9, 0x7C,	0xb3, 0xaf,	0xb4, 0x97,	0xb5, 0xFF,
	0xb0, 0xC5,	0xb1, 0x94,	0xb2, 0x0f,	0xc4, 0x5c,
	0xc0, 0xc8,	0xc1, 0x96,	0x8c, 0x00,	0x86, 0x3d,
	0x50, 0x00,	0x51, 0x90,	0x52, 0x2c,	0x53, 0x00,
	0x54, 0x00,	0x55, 0x88,	0x5a, 0x90,	0x5b, 0x2C,
	0x5c, 0x05,	0xd3, 0x02,	0xc3, 0xed,	0x7f, 0x00,
	0xda, 0x09,	0xe5, 0x1f,	0xe1, 0x67,	0xe0, 0x00,
	0xdd, 0x7f,	0x05, 0x00,
};  
/* SVGA初始化寄存器序列表
	此模式下,帧率可以达到30帧
	SVGA 800*600 */
const u8 OV2640_800x600_SVGA[][2]= 
{    
	0xff, 0x00,	0x2c, 0xff,	0x2e, 0xdf,	0xff, 0x01,
	0x3c, 0x32,	0x11, 0x00,	0x09, 0x02,	0x04, 0xD8,
	0x13, 0xe5,	0x14, 0x48,	0x2c, 0x0c,	0x33, 0x78,
	0x3a, 0x33,	0x3b, 0xfB,	0x3e, 0x00,	0x43, 0x11,
	0x16, 0x10,	0x39, 0x92,	0x35, 0xda,	0x22, 0x1a,
	0x37, 0xc3,	0x23, 0x00,	0x34, 0xc0,	0x36, 0x1a,
	0x06, 0x88,	0x07, 0xc0,	0x0d, 0x87,	0x0e, 0x41,
	0x4c, 0x00,	0x48, 0x00,	0x5B, 0x00,	0x42, 0x03,
	0x4a, 0x81,	0x21, 0x99,	0x24, 0x40,	0x25, 0x38,
	0x26, 0x82,	0x5c, 0x00,	0x63, 0x00,	0x46, 0x22,
	0x0c, 0x3c,	0x61, 0x70,	0x62, 0x80,	0x7c, 0x05,
	0x20, 0x80,	0x28, 0x30,	0x6c, 0x00,	0x6d, 0x80,
	0x6e, 0x00,	0x70, 0x02,	0x71, 0x94,	0x73, 0xc1,
	0x3d, 0x34, 0x5a, 0x57,	0x12, 0x40,	0x17, 0x11,
	0x18, 0x43,	0x19, 0x00,	0x1a, 0x4b,	0x32, 0x09,
	0x37, 0xc0,	0x4f, 0xca,	0x50, 0xa8,	0x5a, 0x23,
	0x6d, 0x00,	0x3d, 0x38,	0xff, 0x00,	0xe5, 0x7f,
	0xf9, 0xc0,	0x41, 0x24,	0xe0, 0x14,	0x76, 0xff,
	0x33, 0xa0,	0x42, 0x20,	0x43, 0x18,	0x4c, 0x00,
	0x87, 0xd5,	0x88, 0x3f,	0xd7, 0x03,	0xd9, 0x10,
	0xd3, 0x82,	0xc8, 0x08,	0xc9, 0x80,	0x7c, 0x00,
	0x7d, 0x00,	0x7c, 0x03,	0x7d, 0x48,	0x7d, 0x48,
	0x7c, 0x08,	0x7d, 0x20,	0x7d, 0x10,	0x7d, 0x0e,
	0x90, 0x00,	0x91, 0x0e,	0x91, 0x1a,	0x91, 0x31,
	0x91, 0x5a,	0x91, 0x69,	0x91, 0x75,	0x91, 0x7e,
	0x91, 0x88,	0x91, 0x8f,	0x91, 0x96,	0x91, 0xa3,
	0x91, 0xaf,	0x91, 0xc4,	0x91, 0xd7,	0x91, 0xe8,
	0x91, 0x20,	0x92, 0x00,	0x93, 0x06,	0x93, 0xe3,
	0x93, 0x05,	0x93, 0x05,	0x93, 0x00,	0x93, 0x04,
	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,
	0x93, 0x00,	0x93, 0x00,	0x93, 0x00,	0x96, 0x00,
	0x97, 0x08,	0x97, 0x19,	0x97, 0x02,	0x97, 0x0c,
	0x97, 0x24,	0x97, 0x30,	0x97, 0x28,	0x97, 0x26,
	0x97, 0x02,	0x97, 0x98,	0x97, 0x80,	0x97, 0x00,
	0x97, 0x00,	0xc3, 0xed,	0xa4, 0x00,	0xa8, 0x00,
	0xc5, 0x11,	0xc6, 0x51,	0xbf, 0x80,	0xc7, 0x10,
	0xb6, 0x66,	0xb8, 0xA5,	0xb7, 0x64,	0xb9, 0x7C,
	0xb3, 0xaf,	0xb4, 0x97,	0xb5, 0xFF,	0xb0, 0xC5,
	0xb1, 0x94,	0xb2, 0x0f,	0xc4, 0x5c,	0xc0, 0x64,
	0xc1, 0x4B,	0x8c, 0x00,	0x86, 0x3D,	0x50, 0x00,
	0x51, 0xC8,	0x52, 0x96,	0x53, 0x00,	0x54, 0x00,
	0x55, 0x00,	0x5a, 0xC8,	0x5b, 0x96,	0x5c, 0x00,
	0xd3, 0x02,	0xc3, 0xed,	0x7f, 0x00,	0xda, 0x09,
	0xe5, 0x1f,	0xe1, 0x67,	0xe0, 0x00,	0xdd, 0x7f,
	0x05, 0x00,
};   


const u8 OV2640_RGB565[][2]=
{
	0xFF, 0x00, 	0xDA, 0x09,//0x09,
	0xD7, 0x03, 	
	0xDF, 0x02,
	0x33, 0xa0, 	
	0x3C, 0x00,
	0xe1, 0x67,
	/*----sensor addr */
	#if 0
	0xff, 0x01, 
	0xe0, 0x00, 	0xe1, 0x00,
	0xe5, 0x00, 	
	0xd7, 0x00, 
	0xda, 0x00, 	0xe0, 0x00,  
	#endif
}; 

/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/
/**
  * @brief  Resets the OV2640 camera.
  * @param  None
  * @retval None
  */
static void OV2640_Reset(void)
{
  OV2640_WriteReg(OV2640_DSP_RA_DLMT, 0x01);
  OV2640_WriteReg(OV2640_SENSOR_COM7, 0x80);
}

/**
  * @brief  Reads the OV2640 Manufacturer identifier.
  * @param  OV2640ID: Pointer to the OV2640 Manufacturer identifier
  * @retval None
  */
static void OV2640_ReadID(OV2640_IDTypeDef *OV2640ID)
{
  OV2640_WriteReg(OV2640_DSP_RA_DLMT, 0x01);
  
  OV2640ID->Manufacturer_ID1 = OV2640_ReadReg(OV2640_SENSOR_MIDH);
  OV2640ID->Manufacturer_ID2 = OV2640_ReadReg(OV2640_SENSOR_MIDL);
  OV2640ID->PIDH = OV2640_ReadReg(OV2640_SENSOR_PIDH);
  OV2640ID->PIDL = OV2640_ReadReg(OV2640_SENSOR_PIDL);
}



/**
  * @brief  Configures the OV2640 camera in QQVGA mode.
  * @param  None
  * @retval None
  */
void OV2640_QQVGAConfig(void)
{
  uint32_t i;

  OV2640_Reset();
  Delay(200);

  /* Initialize OV2640 */
  for(i=0; i<(sizeof(OV2640_QQVGA)/2); i++) {
    OV2640_WriteReg(OV2640_QQVGA[i][0], OV2640_QQVGA[i][1]);
    Delay(2);
  }
}

/**
  * @brief  Configures the OV2640 camera in QVGA mode.
  * @param  None
  * @retval None
  */
void OV2640_QVGAConfig(void)
{
  uint32_t i;

  OV2640_Reset();
  Delay(200);

  /* Initialize OV2640 */
  for(i=0; i<(sizeof(OV2640_QVGA)/2); i++)
  {
    OV2640_WriteReg(OV2640_QVGA[i][0], OV2640_QVGA[i][1]);
    Delay(2);
  }
}

/**
  * @brief  Configures the OV2640 camera in JPEG mode.
  * @param  JPEGImageSize: JPEG image size
  * @retval None
  */
void OV2640_JPEGConfig(ImageFormat_TypeDef ImageFormat)
{
  uint32_t i;

  OV2640_Reset();
  Delay(200);

  /* Initialize OV2640 */
  for(i=0; i<(sizeof(OV2640_JPEG_INIT)/2); i++)
  {
    OV2640_WriteReg(OV2640_JPEG_INIT[i][0], OV2640_JPEG_INIT[i][1]);
  }

  /* Set to output YUV422 */
  for(i=0; i<(sizeof(OV2640_YUV422)/2); i++)
  {
    OV2640_WriteReg(OV2640_YUV422[i][0], OV2640_YUV422[i][1]);
  }

  OV2640_WriteReg(0xff, 0x01);
  OV2640_WriteReg(0x15, 0x00);

  /* Set to output JPEG */
  for(i=0; i<(sizeof(OV2640_JPEG)/2); i++)
  {
    OV2640_WriteReg(OV2640_JPEG[i][0], OV2640_JPEG[i][1]);
  }

  Delay(100);

  switch(ImageFormat)
  {
    case JPEG_160x120:
    {
      for(i=0; i<(sizeof(OV2640_160x120_JPEG)/2); i++)
      {
        OV2640_WriteReg(OV2640_160x120_JPEG[i][0], OV2640_160x120_JPEG[i][1]);
      }
      break;
    }
    case JPEG_176x144:
    {
      for(i=0; i<(sizeof(OV2640_176x144_JPEG)/2); i++)
      {
        OV2640_WriteReg(OV2640_176x144_JPEG[i][0], OV2640_176x144_JPEG[i][1]);
      } 
      break;
    }
    case JPEG_320x240:
    {
       for(i=0; i<(sizeof(OV2640_320x240_JPEG)/2); i++)
      {
        OV2640_WriteReg(OV2640_320x240_JPEG[i][0], OV2640_320x240_JPEG[i][1]);
      }
      break;
    }
    case JPEG_352x288:
    {
      for(i=0; i<(sizeof(OV2640_352x288_JPEG)/2); i++)
      {
        OV2640_WriteReg(OV2640_352x288_JPEG[i][0], OV2640_352x288_JPEG[i][1]);
      }
      break;
    }
    default:
    {
      for(i=0; i<(sizeof(OV2640_160x120_JPEG)/2); i++)
      {
        OV2640_WriteReg(OV2640_160x120_JPEG[i][0], OV2640_160x120_JPEG[i][1]);
      }
      break;
    }
  }
}

/**
  * @brief  Configures the OV2640 camera brightness.
  * @param  Brightness: Brightness value, where Brightness can be: 
  *         0x40 for Brightness +2,
  *         0x30 for Brightness +1,
  *         0x20 for Brightness 0,
  *         0x10 for Brightness -1,
  *         0x00 for Brightness -2,
  * @retval None
  */
void OV2640_BrightnessConfig(uint8_t Brightness)
{
  OV2640_WriteReg(0xff, 0x00);
  OV2640_WriteReg(0x7c, 0x00);
  OV2640_WriteReg(0x7d, 0x04);
  OV2640_WriteReg(0x7c, 0x09);
  OV2640_WriteReg(0x7d, Brightness);
  OV2640_WriteReg(0x7d, 0x00);
}

/**
  * @brief  Configures the OV2640 camera Black and white mode.
  * @param  BlackWhite: BlackWhite value, where BlackWhite can be: 
  *         0x18 for B&W,
  *         0x40 for Negative,
  *         0x58 for B&W negative,
  *         0x00 for Normal,
  * @retval None
  */
void OV2640_BandWConfig(uint8_t BlackWhite)
{
  OV2640_WriteReg(0xff, 0x00);
  OV2640_WriteReg(0x7c, 0x00);
  OV2640_WriteReg(0x7d, BlackWhite);
  OV2640_WriteReg(0x7c, 0x05);
  OV2640_WriteReg(0x7d, 0x80);
  OV2640_WriteReg(0x7d, 0x80);
}

/**
  * @brief  Configures the OV2640 camera color effects.
  * @param  value1: Color effects value1
  * @param  value2: Color effects value2
  *         where value1 and value2 can be: 
  *         value1 = 0x40, value2 = 0xa6 for Antique,
  *         value1 = 0xa0, value2 = 0x40 for Bluish,
  *         value1 = 0x40, value2 = 0x40 for Greenish,
  *         value1 = 0x40, value2 = 0xc0 for Reddish,
  * @retval None
  */
void OV2640_ColorEffectsConfig(uint8_t value1, uint8_t value2)
{
  OV2640_WriteReg(0xff, 0x00);
  OV2640_WriteReg(0x7c, 0x00);
  OV2640_WriteReg(0x7d, 0x18);
  OV2640_WriteReg(0x7c, 0x05);
  OV2640_WriteReg(0x7d, value1);
  OV2640_WriteReg(0x7d, value2);
}

/**
  * @brief  Configures the OV2640 camera contrast.
  * @param  value1: Contrast value1
  * @param  value2: Contrast value2
  *         where value1 and value2 can be: 
  *         value1 = 0x28, value2 = 0x0c for Contrast +2,
  *         value1 = 0x24, value2 = 0x16 for Contrast +1,
  *         value1 = 0x20, value2 = 0x20 for Contrast 0,
  *         value1 = 0x1c, value2 = 0x2a for Contrast -1,
  *         value1 = 0x18, value2 = 0x34 for Contrast -2,
  * @retval None
  */
void OV2640_ContrastConfig(uint8_t value1, uint8_t value2)
{
  OV2640_WriteReg(0xff, 0x00);
  OV2640_WriteReg(0x7c, 0x00);
  OV2640_WriteReg(0x7d, 0x04);
  OV2640_WriteReg(0x7c, 0x07);
  OV2640_WriteReg(0x7d, 0x20);
  OV2640_WriteReg(0x7d, value1);
  OV2640_WriteReg(0x7d, value2);
  OV2640_WriteReg(0x7d, 0x06);
}

/**
  * @brief  OV2640 camera special effects.
* @param  index: 
  * @retval None
  */
void OV2640_SpecialEffects(uint8_t index)
{
  switch (index)
  {
    case 1:
      OV2640_ColorEffectsConfig(0x40, 0xa6);/* Antique */ 
      break;

    case 2:
      OV2640_ColorEffectsConfig(0xa0, 0x40);/* Bluish */
      break;

    case 3:
      OV2640_ColorEffectsConfig(0x40, 0x40);/* Greenish */
      break;

    case 4:
      OV2640_ColorEffectsConfig(0x40, 0xc0);/* Reddish */
      break;
	  
    case 5:
      OV2640_BandWConfig(0x18);/* Black & White */
      break;

    case 6:
      OV2640_BandWConfig(0x40);/* Negative */
      break;

    case 7:
      OV2640_BandWConfig(0x58);/* B&W negative */
      break;

    case 8:
      OV2640_BandWConfig(0x00);/* Normal */
      break;

    default:
      break;
  }
}
/*------------------------------------------------*/
u8 OV2640_UXGAConfig(void)
{ 
	u16 i=0;

	OV2640_Reset();
    Delay(200);

	/* UXGA分辨率(1600*1200) */  
	for(i=0;i<sizeof(OV2640_1600x1200_UXGA)/2;i++) {
		OV2640_WriteReg(OV2640_1600x1200_UXGA[i][0], OV2640_1600x1200_UXGA[i][1]);
	} 
	return 0x00;	//ok
} 

/* 切换为RGB565模式 */
void OV2640_RGB565_Mode(void) 
{
	u16 i=0;

	for(i=0;i<(sizeof(OV2640_RGB565)/2);i++) {
		OV2640_WriteReg(OV2640_RGB565[i][0],OV2640_RGB565[i][1]); 
	} 
} 
/*
	window size >= ImageSize >= ImageWinSize >= OutSize
	0v2640 传感器：
	window size最大就是传感器：1632*1220
	ImageSize：1632*1220
	ImageWinSize：1600*1200
	OutSize：1600*1200
	*/
	
/*  设置传感器输出窗口 
    sx, sy,起始地址
	width,height:宽度(对应:horizontal)和高度(对应:vertical) 
	
	*/
void OV2640_Window_Set(u16 sx, u16 sy, u16 width,u16 height)
{
	u16 endx;
	u16 endy;
	u8 temp; 
	endx=sx+width/2;
	endy=sy+height/2;
	
	OV2640_WriteReg(0XFF,0X01); 		
	temp=OV2640_ReadReg(0X03); 		
	temp&=0XF0;
	temp|=((endy&0X03)<<2)|(sy&0X03);
	OV2640_WriteReg(0X03,temp); 		
	OV2640_WriteReg(0X19,sy>>2);		
	OV2640_WriteReg(0X1A,endy>>2);		
	
	temp=OV2640_ReadReg(0X32); 		
	temp&=0XC0;
	temp|=((endx&0X07)<<3)|(sx&0X07);
	OV2640_WriteReg(0X32,temp); 	
	OV2640_WriteReg(0X17,sx>>3);		
	OV2640_WriteReg(0X18,endx>>3);		
}
/* 该函数设置图像尺寸大小,也就是所选格式的输出分辨率
	UXGA:1600*1200,SVGA:800*600,CIF:352*288
	width,height:图像宽度和图像高度*/
u8 OV2640_ImageSize_Set(u16 width,u16 height)
{ 
	u8 temp; 
	
	OV2640_WriteReg(0XFF,0X00); 		
	OV2640_WriteReg(0XE0,0X04); 		
	OV2640_WriteReg(0XC0,(width)>>3&0XFF);	
	OV2640_WriteReg(0XC1,(height)>>3&0XFF); 
	
	temp=(width&0X07)<<3;
	temp|=height&0X07;
	temp|=(width>>4)&0X80; 
	OV2640_WriteReg(0X8C,temp); 
	OV2640_WriteReg(0XE0,0X00); 			 
	return 0;
}
/* 设置图像开窗大小
	本函数在ImageSize上面进行开窗,用于OV2640_OutSize_Set的输出
	注意:本函数的宽度和高度,必须大于等于OutSize宽度和高度
	OV2640_OutSize_Set设置的宽度和高度,根据本函数设置的宽度和高度,由DSP
	自动计算缩放比例,输出给外部设备.
	   
	width,height:宽度(对应:horizontal)和高度(对应:vertical)
	width和height必须是4的倍数
*/
u8 OV2640_ImageWinSize_Set(u16 offx,u16 offy,u16 width,u16 height)
{
	u16 hsize;
	u16 vsize;
	u8 temp; 
	
	if(width%4)return 1;
	if(height%4)return 2;
	
	hsize=width/4;
	vsize=height/4;
	OV2640_WriteReg(0XFF,0X00); 
	OV2640_WriteReg(0XE0,0X04); 				
	OV2640_WriteReg(0X51,hsize&0XFF);
	OV2640_WriteReg(0X52,vsize&0XFF);	
	OV2640_WriteReg(0X53,offx&0XFF);	
	OV2640_WriteReg(0X54,offy&0XFF);
	
	temp=(vsize>>1)&0X80;
	temp|=(offy>>4)&0X70;
	temp|=(hsize>>5)&0X08;
	temp|=(offx>>8)&0X07; 
	OV2640_WriteReg(0X55,temp); 
	OV2640_WriteReg(0X57,(hsize>>2)&0X80);
	OV2640_WriteReg(0XE0,0X00); 
	return 0;
} 

/*设置图像输出大小
	OV2640输出图像的分辨率
	width,height:宽度(对应:horizontal)和高度(对应:vertical)
	width和height必须是4的倍数
*/
u8 OV2640_OutSize_Set(u16 width,u16 height)
{
	u16 outh;
	u16 outw;
	u8 temp; 
	
	if(width%4)return 1;
	if(height%4)return 2;
	
	outw=width/4;
	outh=height/4; 
	OV2640_WriteReg(0XFF,0X00); 
	OV2640_WriteReg(0XE0,0X04); 		
	OV2640_WriteReg(0X5A,outw&0XFF);
	OV2640_WriteReg(0X5B,outh&0XFF);
	
	temp=(outw>>8)&0X03;
	temp|=(outh>>6)&0X04;
	OV2640_WriteReg(0X5C,temp); 
	OV2640_WriteReg(0XE0,0X00); 
	return 0;
}

/* ---------------------------------------------------
	*/

OV2640_IDTypeDef OV2640_Camera_ID;

int OV2640_Init(void)
{
	OV2640_ReadID(&OV2640_Camera_ID);

	if(OV2640_Camera_ID.PIDH  == 0x26){
		wjq_log(LOG_DEBUG, "OV2640 Camera ID 0x%x\r\n", OV2640_Camera_ID.PIDH);
		return 0;
	}

	return -1;
}

/**
  * @brief  Configures DCMI/DMA to capture image from the OV2640 camera.
  * @param  ImageFormat: Image format BMP or JPEG 
  * @param  BMPImageSize: BMP Image size
  * @retval None
  */
void OV2640_Config(ImageFormat_TypeDef ImageFormat)
{
	switch (ImageFormat)
	{
		case BMP_QVGA:
		{
			//BUS_DCMI_Config(DCMI_PCKPolarity_Rising, DCMI_VSPolarity_Low, DCMI_HSPolarity_Low);
			OV2640_QVGAConfig();
			break;
		}

		case JPEG_160x120:
		case JPEG_176x144:
		case JPEG_320x240:
		case JPEG_352x288:
		{
			//BUS_DCMI_Config(DCMI_PCKPolarity_Rising, DCMI_VSPolarity_High, DCMI_HSPolarity_Low);
			OV2640_JPEGConfig(ImageFormat);
			break;
		}
		
		case BMP_QQVGA:
		default:
		{
			//BUS_DCMI_Config(DCMI_PCKPolarity_Rising, DCMI_VSPolarity_High, DCMI_HSPolarity_Low);
			OV2640_QQVGAConfig();
			break; 
		}
	}

}



#endif

/**
  * @}
  */ 

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
